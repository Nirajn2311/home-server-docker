version: "3"
services:
  plex-media-healthcheck:
    image: node:24-alpine@sha256:f36fed0b2129a8492535e2853c64fbdbd2d29dc1219ee3217023ca48aebd3787
    container_name: plex-media-healthcheck
    env_file: .env
    volumes:
      - ${PLEX_MEDIA_DIR:?media_dir_missing}:/data:ro
    command: sh -c 'until [[ $(ls -A /data | wc -l) -gt 0 ]]; do echo "Waiting for volume to be ready"; sleep 2; done; echo "Volume ready for use"; sleep infinity;'
    healthcheck:
      test: "[[ $(ls -A /data | wc -l) -gt 0 ]] || exit 1"
      interval: 1m
      timeout: 15s
      retries: 3
      start_period: 15s

  plex:
    image: plexinc/pms-docker:1.42.2.10156-f737b826c@sha256:9c03c26b9479ba9a09935f3367459bfdc8d21545f42ed2a13258983c5be1b252
    container_name: plex
    restart: unless-stopped
    env_file: .env
    network_mode: host
    volumes:
      - ./config:/config
      - ./transcode:/transcode
      - ${PLEX_MEDIA_DIR:?media_dir_missing}:/data/media:ro
    depends_on:
      plex-media-healthcheck:
        condition: service_healthy
    labels:
      - com.centurylinklabs.watchtower.enable=true

  tautulli:
    image: ghcr.io/tautulli/tautulli:v2.16.0@sha256:7e6ede32f7923e01899db906aa6a96d978a4a8df8e2ef0dcf44c92b2d0206221
    container_name: tautulli
    restart: unless-stopped
    environment:
      - TZ=${TZ}
    ports:
      - "8181:8181"
    volumes:
      - ./tautulli-config:/config
    depends_on:
      - plex
